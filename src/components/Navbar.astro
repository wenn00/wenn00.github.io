---
const currentPath = Astro.url.pathname;
---

<nav class="fixed top-0 left-0 right-0 z-50 bg-white border-b border-border">
  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex justify-between items-center h-16">
      <!-- Logo -->
      <a href="/" class="text-xl font-bold text-primary">[WN]</a>

      <!-- Desktop Nav -->
      <div class="hidden md:flex items-center gap-8">
        <a href="/" class:list={["nav-link", { active: currentPath === '/' }]} data-i18n="nav.home">首頁</a>
        <a href="/about" class:list={["nav-link", { active: currentPath === '/about/' || currentPath === '/about' }]} data-i18n="nav.about">關於我</a>
        <a href="/projects" class:list={["nav-link", { active: currentPath === '/projects/' || currentPath === '/projects' }]} data-i18n="nav.projects">專案</a>
        <a href="/contact" class:list={["nav-link", { active: currentPath === '/contact/' || currentPath === '/contact' }]} data-i18n="nav.contact">聯絡</a>

        <!-- Language Toggle -->
        <button id="lang-toggle" class="ml-4 px-3 py-1 text-sm border border-border rounded-md hover:bg-bg-gray transition-colors">
          中 / EN
        </button>
      </div>

      <!-- Mobile Hamburger -->
      <button id="menu-toggle" class="md:hidden p-2 text-body hover:text-heading" aria-label="Toggle menu" aria-expanded="false">
        <svg id="menu-icon-open" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
        </svg>
        <svg id="menu-icon-close" class="w-6 h-6 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class="hidden md:hidden border-t border-border bg-white">
    <div class="px-4 py-4 flex flex-col gap-3">
      <a href="/" class:list={["mobile-nav-link", { active: currentPath === '/' }]} data-i18n="nav.home">首頁</a>
      <a href="/about" class:list={["mobile-nav-link", { active: currentPath === '/about/' || currentPath === '/about' }]} data-i18n="nav.about">關於我</a>
      <a href="/projects" class:list={["mobile-nav-link", { active: currentPath === '/projects/' || currentPath === '/projects' }]} data-i18n="nav.projects">專案</a>
      <a href="/contact" class:list={["mobile-nav-link", { active: currentPath === '/contact/' || currentPath === '/contact' }]} data-i18n="nav.contact">聯絡</a>
      <button id="lang-toggle-mobile" class="mt-2 px-3 py-2 text-sm border border-border rounded-md hover:bg-bg-gray transition-colors w-fit">
        中 / EN
      </button>
    </div>
  </div>
</nav>

<style>
  .nav-link {
    color: var(--color-body);
    font-size: 0.875rem;
    font-weight: 500;
    padding-bottom: 2px;
    border-bottom: 2px solid transparent;
    transition: color 0.2s, border-color 0.2s;
  }
  .nav-link:hover,
  .nav-link.active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }
  .mobile-nav-link {
    color: var(--color-body);
    font-size: 1rem;
    font-weight: 500;
    padding: 0.5rem 0;
    transition: color 0.2s;
  }
  .mobile-nav-link:hover,
  .mobile-nav-link.active {
    color: var(--color-primary);
  }
</style>

<script>
  import { getLang, setLang } from '../i18n/utils';
  import zh from '../i18n/zh.json';
  import en from '../i18n/en.json';

  const translations: Record<string, Record<string, unknown>> = { zh, en };

  function getNestedValue(obj: unknown, path: string): string | undefined {
    const keys = path.split('.');
    let value: unknown = obj;
    for (const k of keys) {
      if (value && typeof value === 'object') {
        value = (value as Record<string, unknown>)[k];
      } else {
        return undefined;
      }
    }
    return typeof value === 'string' ? value : undefined;
  }

  function applyTranslations() {
    const lang = getLang();
    const dict = translations[lang] ?? translations['zh'];
    document.querySelectorAll('[data-i18n]').forEach(el => {
      const key = el.getAttribute('data-i18n');
      if (key) {
        const text = getNestedValue(dict, key);
        if (text) el.textContent = text;
      }
    });
  }

  // Hamburger menu toggle
  const menuToggle = document.getElementById('menu-toggle');
  const mobileMenu = document.getElementById('mobile-menu');
  const iconOpen = document.getElementById('menu-icon-open');
  const iconClose = document.getElementById('menu-icon-close');

  menuToggle?.addEventListener('click', () => {
    const isHidden = mobileMenu?.classList.contains('hidden');
    mobileMenu?.classList.toggle('hidden');
    iconOpen?.classList.toggle('hidden');
    iconClose?.classList.toggle('hidden');
    menuToggle?.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
  });

  // Language toggle
  function toggleLang() {
    const current = getLang();
    setLang(current === 'zh' ? 'en' : 'zh');
  }

  document.getElementById('lang-toggle')?.addEventListener('click', toggleLang);
  document.getElementById('lang-toggle-mobile')?.addEventListener('click', toggleLang);

  // Apply translations on load
  applyTranslations();
</script>
